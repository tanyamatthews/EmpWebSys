USE EmployeeSystems;
INSERT INTO project VALUES('','Project1','2015-01-01','2017-12-10');
INSERT INTO project VALUES('','Project2','2016-01-01','2016-12-10');
INSERT INTO project VALUES('','Project3','2017-01-01','2017-12-10');
INSERT INTO project VALUES('','Project4','2017-01-01','2017-12-10');
INSERT INTO project VALUES('','Project5','2017-01-01','2017-12-10');
INSERT INTO project VALUES('','Project6','2017-01-01','2017-12-10');

INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2015-12-02","Reece","Elliott","Mr.","54034"),("2016-05-29","Sylvester","Pierce","Mr.","61439"),("2016-03-09","Lars","Brennan","Mrs.","80771"),("2016-03-24","Wyatt","Huff","Ms.","76316"),("2016-02-05","Carter","Keller","Ms.","42252"),("2014-11-18","Carl","Ellison","Mr.","22339"),("2015-01-25","Kareem","Blair","Dr.","94379"),("2015-06-18","Thomas","Larsen","Mr.","84856"),("2016-06-04","Talon","Hampton","Dr.","97445"),("2015-11-29","Sylvester","Wilder","Mrs.","69531");
INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2015-06-13","Driscoll","Bentley","Mr.","19749"),("2015-12-21","Lee","Delacruz","Dr.","86549"),("2015-01-31","Bradley","Paul","Mr.","82655"),("2015-10-29","Lars","May","Mr.","62126"),("2016-02-18","Josiah","Garrison","Ms.","55340"),("2016-02-28","Jamal","Nguyen","Mr.","67173"),("2015-04-15","Mannix","Duran","Dr.","87359"),("2015-10-29","Bradley","Pacheco","Mr.","58395"),("2015-07-14","Yasir","Nichols","Ms.","37108"),("2015-01-26","Ulysses","Herring","Mr.","41056");
INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2015-09-20","Phelan","Marquez","Dr.","81604"),("2014-10-28","Oliver","Petersen","Mr.","2376"),("2014-12-24","Palmer","Gamble","Dr.","48071"),("2015-10-19","Reed","Burch","Mr.","66518"),("2016-03-29","Rudyard","Stone","Mr.","44576"),("2014-12-22","Chancellor","Park","Mr.","53182"),("2016-02-21","Shad","Gray","Dr.","9515"),("2015-05-06","Bruce","Hall","Ms.","13375"),("2016-07-14","Gannon","Shaw","Mrs.","95992"),("2015-10-19","Valentine","Watson","Ms.","83121");
INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2016-01-21","Fletcher","Avila","Dr.","83047"),("2016-08-23","Gage","Kirby","Mr.","54161"),("2015-12-28","Darius","Patton","Dr.","53653"),("2016-07-24","Shad","Pearson","Ms.","33262"),("2014-10-30","Steven","Moran","Dr.","34135"),("2016-10-06","Tiger","Oliver","Ms.","36151"),("2015-04-23","Ivan","Gutierrez","Mrs.","59283"),("2015-09-11","Caleb","Kirby","Ms.","7359"),("2015-09-22","Michael","George","Ms.","67316"),("2015-10-17","Evan","Watkins","Dr.","48926");
INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2016-02-05","Kenyon","Sampson","Dr.","41598"),("2015-02-02","Oscar","Carrillo","Dr.","17593"),("2016-07-12","James","Russell","Mrs.","80538"),("2016-02-07","Guy","Snow","Ms.","47154"),("2016-01-29","Xavier","Hooper","Mr.","19324"),("2015-05-17","Ezekiel","Sears","Mrs.","1507"),("2015-12-09","Boris","Burt","Ms.","74637"),("2015-08-20","Hilel","Frye","Mr.","61788"),("2015-12-14","Randall","Kennedy","Mrs.","95763"),("2014-12-24","Victor","Peck","Dr.","24393");
INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2015-07-30","Griffin","Horton","Mrs.","48513"),("2016-06-21","Hector","Odonnell","Ms.","55310"),("2014-11-11","Malachi","Montoya","Ms.","99863"),("2015-05-31","Lucian","Griffith","Dr.","53999"),("2014-12-17","Jackson","Greer","Ms.","6267"),("2015-11-03","Lester","Miles","Ms.","67760"),("2015-04-22","Zeus","Bentley","Ms.","40368"),("2016-03-13","Malik","King","Dr.","36844"),("2016-07-11","Lucian","Barrett","Mr.","3769"),("2015-06-18","Anthony","Robbins","Dr.","48897");
INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2015-06-13","Dean","Boyle","Mrs.","37054"),("2016-09-18","Henry","Hahn","Ms.","24423"),("2015-08-28","Talon","Espinoza","Ms.","71585"),("2016-04-12","Lester","Pollard","Mr.","29639"),("2015-06-21","Nehru","Crosby","Ms.","47931"),("2016-05-18","Ali","Mckee","Ms.","98423"),("2015-06-22","Jameson","Vargas","Dr.","31342"),("2016-04-12","Aladdin","Mcfarland","Ms.","26770"),("2015-09-09","Akeem","Alvarez","Ms.","43581"),("2015-02-22","Vernon","Bruce","Dr.","82442");
INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2015-09-28","Hilel","Beck","Mrs.","13917"),("2016-10-16","Castor","Gallegos","Ms.","51014"),("2015-05-19","Ivor","Drake","Dr.","10478"),("2015-05-08","Yasir","Wong","Dr.","71729"),("2015-03-01","Chase","Johnston","Mr.","88979"),("2015-10-26","Nissim","Valenzuela","Mr.","27639"),("2016-09-24","Price","Vinson","Ms.","66330"),("2016-09-06","Steven","Eaton","Ms.","71619"),("2016-10-08","Richard","Sears","Dr.","87108"),("2015-11-17","Nathan","Haynes","Mr.","56308");
INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2016-08-04","Zachary","Sampson","Ms.","60938"),("2015-03-04","Alan","Warner","Ms.","29694"),("2015-10-07","Lucas","Haynes","Mrs.","68543"),("2016-09-12","Fritz","Knapp","Dr.","50364"),("2015-05-07","Demetrius","Ortiz","Dr.","38913"),("2016-09-15","Gareth","Anderson","Mr.","61534"),("2015-03-21","Jason","Barnes","Dr.","0840"),("2015-02-12","Vincent","Delgado","Mrs.","7564"),("2016-09-19","Shad","Simon","Dr.","73631"),("2015-02-24","Arthur","Houston","Dr.","91257");
INSERT INTO `employee` (`DateOfBirth`,`F_name`,`L_name`,`Title`,`Salary`) VALUES ("2014-12-28","Arthur","Holman","Dr.","65042"),("2016-10-05","Jelani","Knight","Dr.","87328"),("2014-11-11","Brock","Mcdowell","Mr.","22142"),("2015-10-18","Maxwell","English","Ms.","9710"),("2015-09-12","Leroy","Solis","Mr.","84206"),("2016-06-17","Laith","Cunningham","Mr.","76104"),("2015-11-24","Tobias","Singleton","Mrs.","1573"),("2016-08-15","Ezekiel","Solis","Dr.","74438"),("2015-07-01","Oliver","Rollins","Mrs.","79025"),("2016-08-31","Amir","Burnett","Ms.","81338");

INSERT INTO employee_billable VALUES('1','10','');
INSERT INTO employee_billable VALUES('2','5','');
INSERT INTO employee_billable VALUES('3','2.5','');
INSERT INTO employee_billable VALUES('4','100','');
INSERT INTO employee_billable VALUES('5','25','');
INSERT INTO employee_billable VALUES('6','15','');

INSERT INTO employee_sales VALUES('7','0.1','70000');
INSERT INTO employee_sales VALUES('8','0.2','80000');
INSERT INTO employee_sales VALUES('9','0.2','90000');
INSERT INTO employee_sales VALUES('10','0.05','100000');
INSERT INTO project_staff VALUES('1','1','2015-01-02','2015-12-09');
INSERT INTO project_staff VALUES('2','1','2016-04-02','2015-06-09');
INSERT INTO project_staff VALUES('3','2','2016-04-02','2016-12-09');
INSERT INTO project_staff VALUES('4','2','2016-11-02','2016-11-09');
INSERT INTO project_staff VALUES('5','3','2017-01-02','2017-03-09');
INSERT INTO project_staff VALUES('6','3','2017-01-02','2017-12-09');
INSERT INTO theProcs values('help','No Syntax','Lists help for all procedures');
INSERT INTO theProcs values('addEmployee','DOB(YYYY-MM-DD), FirstName, LastName, Title, Picture, Salary','Adds employee to the employee database');
INSERT INTO theProcs values('addSalesEmployee','EmployeeId, Comission Rate, Total Annual Revenue','Adds employee to the sales employee database');
INSERT INTO theProcs values('addBillableEmployee','EmployeeId, Daily Rate, CV','Adds employee to billable employees database');
INSERT INTO theProcs values('addProject','Project Name, Start Date(YYYY-MM-DD), End Date(YYYY-MM-DD)','Adds new project to projects database');
INSERT INTO theProcs values('assignToProject','Employee ID, Project ID, Start Date(YYYY-MM-DD), End Date(YYYY-MM-DD)','Assign an employee to a project');
INSERT INTO theProcs values('showEmployees','No Syntax','Lists all employees');
INSERT INTO theProcs values('showProjects','No Syntax','Lists all projects');
INSERT INTO theProcs values('showSalesEmployees','No Syntax','Lists all sales employees');
INSERT INTO theProcs values('showBillableEmployees','No Syntax','Lists all billable employees');
INSERT INTO theProcs values('searchReport','Employee ID','Returns salary for individual');
INSERT INTO theProcs values('genReport','No Syntax','Generates a payroll');
INSERT INTO theProcs values('showProjectEmployees','Project ID','Lists employees that have worked on a certain project');
INSERT INTO theProcs values('freeEmployees','Month(MM), Year(YYYY)','Shows employees that aren''t on a project on a given month');
INSERT INTO theProcs values('calcEmployees','Month(MM), Year(YYYY)','Calculates the total income for a given month');
INSERT INTO users (fullName, userName, password) VALUES ('Admin Account', 'admin', 'password1');
INSERT INTO users (fullName, userName, password) VALUES ('Finance Account', 'finance', 'password2');
INSERT INTO users (fullName, userName, password) VALUES ('Chris Reid', 'chrisr', 'password3');

DELIMITER // 
CREATE PROCEDURE help (
	)
BEGIN
SELECT procName AS 'Procedure Name', 
procSynt AS 'Procedure Syntax', 
procDesc AS 'Procedure Description' FROM theProcs;
end //
DELIMITER ;
DELIMITER // 

CREATE PROCEDURE addEmployee (
	DOB datetime, f_name varchar(30), l_name varchar(30), 
	title varchar(20), picture blob, salary decimal(11,2)
	)
BEGIN
INSERT INTO employee(DateOfBirth, F_name, L_name, Title, Picture, Salary)
VALUES (dob, f_name, l_name, title, picture, salary);
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE addSalesEmployee (
	ID int(11), CR decimal(5,2), 
	TR decimal(10,2)
	)
BEGIN
INSERT INTO employee_sales(employee_id, commission_rate, total_annual_revenue)
VALUES (ID, CR, TR);
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE addBillableEmployee (
	ID int(11), DR decimal(8,2), 
	CVO blob 
	)
BEGIN
INSERT INTO employee_billable(employee_id, day_rate, CV)
VALUES (ID, DR, CVO);
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE updateEmployee (id int(11),
	DOB datetime, f_name varchar(30), l_name varchar(30), 
	title varchar(20), picture blob, salary decimal(11,2)
	)
BEGIN
	UPDATE employee
	SET DateOfBirth = dob, F_name = f_name, L_name = l_name, 
		Title = title, Picture = picture, Salary = salary
	WHERE employee_id = id;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE updateBillableEmployee (id int(11),
	DOB datetime, f_name varchar(30), l_name varchar(30), 
	title varchar(20), picture blob, salary decimal(11,2),
	DR decimal(8,2), CVO blob
	)
BEGIN
	UPDATE employee
	SET DateOfBirth = dob, F_name = f_name, L_name = l_name, 
		Title = title, Picture = picture, Salary = salary
	WHERE employee_id = id;
	UPDATE employee_billable
	SET day_rate = DR, CV = CVO
	WHERE employee_id = id;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE updateSalesEmployee (id int(11),
	DOB datetime, f_name varchar(30), l_name varchar(30), 
	title varchar(20), picture blob, salary decimal(11,2),
	CR decimal(5,2), TR decimal(10,2)
	)
BEGIN
	UPDATE employee
	SET DateOfBirth = dob, F_name = f_name, L_name = l_name, 
		Title = title, Picture = picture, Salary = salary
	WHERE employee_id = id;
	UPDATE employee_sales
	SET commission_rate = CR, total_annual_revenue = TR
	WHERE employee_id = id;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE deleteEmployee (id int(11))
BEGIN
	DELETE FROM employee WHERE employee_id = id;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE addProject ( 
	Pname varchar(30), 
	Sdate datetime, 
	Edate datetime 
	)
BEGIN
INSERT INTO project(name, start_date, end_date )
VALUES (Pname, Sdate, Edate);
end //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE removeProject(
	PID int(11)
)
BEGIN
DELETE FROM project
WHERE project_id=PID;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE updateProject(
	PID int(11),
	PNAME varchar(30),
	SDATE datetime,
	EDATE datetime
)
BEGIN
	UPDATE project
	SET name = PNAME, start_date = SDATE, end_date = EDATE
	WHERE project_id = PID;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE assignToProject (
	EID int(11),
	PID int(11),
	Sdate datetime, 
	Edate datetime 
	)
BEGIN
SET @tempStart := (SELECT start_date FROM project WHERE project_id = PID);
SET @tempEnd := (SELECT end_date FROM project WHERE project_id = PID);

IF ((Sdate between @tempStart and @tempEnd) AND 
(Edate between @tempStart and @tempEnd)) THEN
INSERT INTO project_staff(employee_id, project_id, start_date, 
	end_date)
VALUES (EID, PID, Sdate, Edate);
ELSE SELECT 'Error, these are not valid dates for this project';
END IF;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE showEmployees ()
BEGIN
SELECT employee_id, CONCAT(Title, '.',F_name, ' ',L_name) AS 'Employee Name' FROM employee;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE showProjects ()
BEGIN
SELECT project_id, name AS 'Project Name' FROM project;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE showSalesEmployees ()
BEGIN
SELECT employee.employee_id, CONCAT(Title, '.',F_name, ' ',L_name) AS 'Sales Employee Name', 
CONCAT(ROUND(commission_rate,2),'%') AS 'Commission Rate' 
FROM employee JOIN employee_sales ON employee.employee_id = employee_sales.employee_id ;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE showBillableEmployees ()
BEGIN
SELECT employee.employee_id, CONCAT(Title, '.',F_name, ' ',L_name) AS 'Billable Employee Name', 
CONCAT(ROUND(day_rate,2),'%') AS 'Day Rate' 
FROM employee JOIN employee_billable ON employee.employee_id = employee_billable.employee_id ;
end //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE searchReport (ID int(11)) BEGIN 
SELECT @ID := employee_sales.employee_id 
FROM employee JOIN employee_sales ON employee.employee_id = employee_sales.employee_id 
WHERE employee_sales.employee_id = ID;
if(@ID = ID) 
THEN SELECT (employee.Salary+((total_annual_revenue/100)*commission_rate)) FROM employee_sales JOIN employee ON employee.employee_id = employee_sales.employee_id 
WHERE employee_sales.employee_id = ID;
ELSE SELECT Salary FROM employee WHERE employee_id = ID; 
END IF;
END //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE genReport () 
BEGIN 
SELECT @temp := employee.employee_id AS 'Employee Id', 
concat(F_name, ' ', L_name) AS 'Employee Name', 
if(@temp IN(SELECT employee_id FROM employee_sales), 
(SELECT CONCAT('£',ROUND(Salary+((total_annual_revenue/100)*commission_rate)))
from employee JOIN employee_sales ON employee.employee_id = employee_sales.employee_id ), 
CONCAT('£',ROUND(employee.Salary))) AS 'Total Amount Due'
FROM employee; 
END //
DELIMITER ;

DELIMITER //
 CREATE PROCEDURE showProjectEmployees (ID int(11)) 
BEGIN 
SELECT CONCAT(employee.F_name, ' ', employee.L_name) 
FROM employee 
JOIN project_staff ON employee.employee_id = project_staff.employee_id 
JOIN project on project.project_id = project_staff.project_id 
WHERE project.project_id = ID; 
END//
DELIMITER ;

DELIMITER //
 CREATE PROCEDURE freeEmployees (month int(2), year int(4)) 
BEGIN 
declare start_Date datetime;
declare end_Date datetime;
SET start_Date := Concat(year,'-',month,'-01');
SET end_Date := Concat(year,'-',month,'-',(SELECT DAY(LAST_DAY(start_Date))));
SELECT employee.F_name, employee.employee_id FROM employee WHERE employee.employee_id NOT IN 
(SELECT project_staff.employee_id FROM project_staff 
WHERE 
(start_Date between project_staff.start_date and project_staff.end_date) 
OR 
(end_Date between project_staff.start_date and project_staff.end_date));
END //
DELIMITER ;

DELIMITER //
 CREATE PROCEDURE calcEmployees (month int(2), year int(4)) 
BEGIN 
declare start_Date datetime;
declare end_Date datetime;
declare billable_days int;
declare month_days int;
SET start_Date := Concat(year,'-',month,'-01');
SET month_days := (SELECT DAY(LAST_DAY(start_Date)));
SET end_Date := Concat(year,'-',month,'-',month_days);
SELECT  SUM((IFNULL(employee_billable.day_rate,0)*IFNULL((CASE 
WHEN (project_staff.start_date BETWEEN start_Date AND end_Date) AND 
(project_staff.end_date BETWEEN start_Date AND end_Date)
THEN  DATEDIFF(project_staff.end_date,project_staff.start_date)
WHEN (project_staff.start_date BETWEEN start_Date AND end_Date) AND
(project_staff.end_date NOT BETWEEN start_Date AND end_Date) 
THEN  DATEDIFF(end_Date,project_staff.start_date)
WHEN (project_staff.end_date BETWEEN start_Date AND end_Date) AND
(project_staff.start_date NOT BETWEEN start_Date AND end_Date) 
THEN  DATEDIFF(project_staff.end_date,start_Date)
WHEN  (project_staff.end_date NOT BETWEEN start_Date AND end_Date) AND
(project_staff.start_date NOT BETWEEN start_Date AND end_Date) 
THEN  month_days
else '0'
END),0))) AS 'Total Monthly Income'
FROM  employee_billable 
JOIN project_staff ON employee_billable.employee_id = project_staff.employee_id 
WHERE employee_billable.employee_id IN 
(SELECT project_staff.employee_id FROM project_staff 
WHERE 
(start_Date between project_staff.start_date and project_staff.end_date) 
OR 
(end_Date between project_staff.start_date and project_staff.end_date));
END //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE showEmployeesWithoutProjects()
BEGIN
	SELECT employee.employee_id, employee.DateOfBirth,
		employee.F_name, employee.L_name, employee.Title, employee.Picture, employee.Salary
	FROM employee LEFT JOIN project_staff
	ON employee.employee_id = project_staff.employee_id
	WHERE project_staff.project_id IS NULL;
end //
DELIMITER ;

DELIMITER // 
CREATE PROCEDURE showProjectsWithoutEmployees()
BEGIN
	SELECT project.project_id, project.name, project.start_date, project.end_date
	FROM project LEFT JOIN project_staff
	ON project.project_id = project_staff.project_id
	WHERE project_staff.project_id IS NULL;
end //
DELIMITER ;
